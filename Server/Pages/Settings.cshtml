@page "/admin/settings"
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Settings";
}

<style>
    .settings-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        border-bottom: 1px solid var(--border-subtle);
    }

    .tab-btn {
        background: transparent;
        border: none;
        color: var(--text-muted);
        padding: 0.75rem 0;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        position: relative;
        transition: color 0.3s ease;
    }

        .tab-btn:hover {
            color: var(--text-white);
        }

        .tab-btn.active {
            color: var(--primary);
        }

            .tab-btn.active::after {
                content: '';
                position: absolute;
                bottom: -1px;
                left: 0;
                width: 100%;
                height: 2px;
                background-color: var(--primary);
                box-shadow: 0 0 10px var(--primary-glow);
            }

    /* Form Grid Layout */
    .settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .full-width {
        grid-column: span 2;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-muted);
        font-size: 0.85rem;
        font-weight: 500;
    }

    .settings-input {
        width: 100%;
    }

        .settings-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
        }

    .toggle-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid var(--border-subtle);
    }

        .toggle-row:last-child {
            border-bottom: none;
        }

    .toggle-info h4 {
        color: var(--text-white);
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .toggle-info p {
        color: var(--text-muted);
        font-size: 0.8rem;
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
    }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--bg-input);
        border: 1px solid var(--border-subtle);
        transition: .4s;
        border-radius: 34px;
    }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: var(--text-muted);
            transition: .4s;
            border-radius: 50%;
        }

    input:checked + .slider {
        background-color: var(--primary);
        border-color: var(--primary);
    }

        input:checked + .slider:before {
            transform: translateX(20px);
            background-color: white;
        }

    .action-bar {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-subtle);
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius-md);
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-secondary {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-main);
        border: 1px solid var(--border-subtle);
    }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

    .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 12px var(--primary-glow);
    }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

    .btn-spinner {
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top: 2px solid #fff;
        width: 14px;
        height: 14px;
        animation: spin 1s linear infinite;
        display: none;
    }

    keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    media (max-width: 768px) {
        .settings-grid {
            grid-template-columns: 1fr;
        }

        .full-width {
            grid-column: span 1;
        }
    }
</style>

<div class="card">
    <div class="card-header">
        <div class="card-title">System Configuration</div>
    </div>

    <div class="card-body" style="padding: 2rem;">
        <div id="save-alert" class="alert alert-success" style="display: none; border-left: 4px solid var(--success); background: rgba(16, 185, 129, 0.1); color: var(--success);">
            <i class="fas fa-check-circle"></i> Settings updated successfully.
        </div>

        <div class="settings-tabs">
            <button class="tab-btn active" onclick="switchTab('general')">General</button>
            <button class="tab-btn" onclick="switchTab('security')">Security</button>
            <button class="tab-btn" onclick="switchTab('advanced')">Advanced</button>
        </div>

        <form id="settings-form" onsubmit="handleSave(event)">

            <div id="tab-general" class="tab-content">
                <div class="settings-grid">
                    <div class="form-group full-width">
                        <label class="form-label">Site Name</label>
                        <input type="text" id="siteName" class="form-input settings-input" placeholder="My Awesome Site">
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">Site Description</label>
                        <input type="text" id="siteDesc" class="form-input settings-input" placeholder="A brief description of your site">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Admin Email</label>
                        <input type="email" id="adminEmail" class="form-input settings-input" placeholder="admin@example.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Timezone</label>
                        <select id="timezone" class="form-input settings-input">
                            <option value="UTC">UTC (Coordinated Universal Time)</option>
                            <option value="EST">EST (Eastern Standard Time)</option>
                            <option value="PST">PST (Pacific Standard Time)</option>
                        </select>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">Footer Text</label>
                        <input type="text" id="footerText" class="form-input settings-input" placeholder="© 2023 My Company">
                    </div>
                </div>
            </div>

            <div id="tab-security" class="tab-content" style="display: none;">
                <div class="toggle-row">
                    <div class="toggle-info">
                        <h4>Force HTTPS</h4>
                        <p>Automatically redirect all HTTP traffic to HTTPS.</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="forceHttps">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="toggle-row">
                    <div class="toggle-info">
                        <h4>Allow Registration</h4>
                        <p>Allow new users to create public accounts.</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="allowRegistration">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="toggle-row">
                    <div class="toggle-info">
                        <h4>Two-Factor Auth (Admin)</h4>
                        <p>Require 2FA for all administrator accounts.</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="require2FA">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="settings-grid" style="margin-top: 2rem;">
                    <div class="form-group">
                        <label class="form-label">Session Timeout (Minutes)</label>
                        <input type="number" id="sessionTimeout" class="form-input settings-input" value="60">
                    </div>
                </div>
            </div>

            <div id="tab-advanced" class="tab-content" style="display: none;">
                <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                    <i class="fas fa-info-circle"></i>
                    <span>These settings affect system performance and caching.</span>
                </div>

                <div class="toggle-row">
                    <div class="toggle-info">
                        <h4>Enable Caching</h4>
                        <p>Cache static assets and database queries.</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="enableCache" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="toggle-row">
                    <div class="toggle-info">
                        <h4>Maintenance Mode</h4>
                        <p>Take the site offline for non-administrators.</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="maintenanceMode">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="settings-grid" style="margin-top: 2rem;">
                    <div class="form-group full-width">
                        <label class="form-label">Custom CSS (Injected in &lt;head&gt;)</label>
                        <textarea id="customCss" class="form-input settings-input" rows="6" style="font-family: monospace;"></textarea>
                    </div>
                </div>
            </div>

            <div class="action-bar">
                <button type="button" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary" id="saveBtn">
                    <span>Save Changes</span>
                    <div class="btn-spinner" id="btnSpinner"></div>
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).style.display = 'block';

            const btns = Array.from(document.querySelectorAll('.tab-btn'));
            const activeBtn = btns.find(b => b.getAttribute('onclick').includes(tabName));
            if (activeBtn) activeBtn.classList.add('active');
        }

        async function fetchSettings() {
            try {
                const response = await apiRequest('/api/settings', { method: 'GET' });

                if (!response.ok) {
                    throw new Error('Failed to fetch settings');
                }

                const data = await response.json();

                const setVal = (id, val) => {
                    const el = document.getElementById(id);
                    if (el) el.value = val;
                };

                const setCheck = (id, val) => {
                    const el = document.getElementById(id);
                    if (el) el.checked = val;
                };

                if(data.general) {
                    setVal("siteName", data.general.siteName);
                    setVal("siteDesc", data.general.siteDescription);
                    setVal("adminEmail", data.general.adminEmail);
                    setVal("timezone", data.general.timezone);
                    setVal("footerText", data.general.footerText);
                }

                if(data.security) {
                    setCheck("forceHttps", data.security.forceHttps);
                    setCheck("allowRegistration", data.security.allowRegistration);
                    setCheck("require2FA", data.security.require2FA);
                    setVal("sessionTimeout", data.security.sessionTimeout);
                }

                if(data.advanced) {
                    setCheck("enableCache", data.advanced.enableCache);
                    setCheck("maintenanceMode", data.advanced.maintenanceMode);
                    setVal("customCss", data.advanced.customCss);
                }

            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        async function handleSave(event) {
            event.preventDefault();

            const saveBtn = document.getElementById('saveBtn');
            const btnSpinner = document.getElementById('btnSpinner');
            const alertBox = document.getElementById('save-alert');
            const btnText = saveBtn.querySelector('span');

            saveBtn.disabled = true;
            btnSpinner.style.display = 'block';
            btnText.textContent = 'Saving...';
            alertBox.style.display = 'none';

            const payload = {
                general: {
                    siteName: document.getElementById('siteName').value,
                    siteDescription: document.getElementById('siteDesc').value,
                    adminEmail: document.getElementById('adminEmail').value,
                    timezone: document.getElementById('timezone').value,
                    footerText: document.getElementById('footerText').value
                },
                security: {
                    forceHttps: document.getElementById('forceHttps').checked,
                    allowRegistration: document.getElementById('allowRegistration').checked,
                    require2FA: document.getElementById('require2FA').checked,
                    sessionTimeout: parseInt(document.getElementById('sessionTimeout').value)
                },
                advanced: {
                    enableCache: document.getElementById('enableCache').checked,
                    maintenanceMode: document.getElementById('maintenanceMode').checked,
                    customCss: document.getElementById('customCss').value
                }
            };

            try {
                const response = await apiRequest('/api/settings', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alertBox.style.display = 'flex';
                    setTimeout(() => {
                        alertBox.style.display = 'none';
                    }, 3000);
                } else {
                    console.error('Save failed');
                    alert('Failed to save settings. Please check console.');
                }

            } catch (error) {
                console.error('Error saving settings:', error);
            } finally {
                saveBtn.disabled = false;
                btnSpinner.style.display = 'none';
                btnText.textContent = 'Save Changes';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchSettings();
            Delau
        });
    </script>
}